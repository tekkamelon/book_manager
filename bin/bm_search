#!/bin/sh

# 環境変数設定
export LC_ALL=C
export LANG=C
export POSIXLY_CORRECT=1

set -eu

# デフォルト変数
api="openbd"
fallback_enabled=0
downloader=""

# ダウンローダ検出
if command -v wget >/dev/null 2>&1; then
	downloader="wget"
elif command -v curl >/dev/null 2>&1; then
	downloader="curl"
else
	echo 'Error: please install "wget" or "curl"' >&2
	exit 1
fi

# 引数解析
isbn=""

while [ "${#}" -gt 0 ]; do

	case "${1}" in
		-o) api="openbd"; shift ;;
		-n) api="ndl"; shift ;;
		-f) fallback_enabled=1; shift ;;
		-h)
			cat <<- EOF
			Usage: bm_search [options] <ISBN>

			Options:
			  -o        Use openBD (default)
			  -n        Use National Diet Library (NDL) API
			  -f        Enable fallback to the other API if no result
			  -h        Show this help message and exit

			Examples:
			  bm_search -o 9784839961451
			  echo 9784839961451 | bm_search -n
			EOF
			exit 0
			;;
		-*)
			echo "Error: Unknown option: $1" >&2
			exit 1
			;;
		[0-9]*)
			if [ -z "${isbn}" ]; then
				isbn="${1}"
			else
				echo "Error: Multiple ISBNs provided" >&2
				exit 1
			fi
			shift
			;;
	esac

done

# ISBN入力確認
if [ -p /dev/stdin ]; then

	read -r isbn < /dev/stdin

elif [ -z "${isbn}" ]; then

	echo "Error: ISBN not provided" >&2
	exit 1

fi


# ====== 関数の設定 ======
# データを取得する関数
fetch_data() {

	url="${1}"
	case "${downloader}" in
		wget)
			if ! wget -q -O - -- "${url}" 2>/dev/null; then
				echo 'Error: Failed to fetch data from URL' >&2
				exit 1
			fi
			;;
		curl)
			if ! curl -L -s -- "${url}" 2>/dev/null; then
				echo 'Error: Failed to fetch data from URL' >&2
				exit 1
			fi
			;;
		*)
			echo 'Error: No available downloader' >&2
			exit 1
			;;

	esac

}

# openBDから書籍情報を取得する関数
fetch_openbd() {

	isbn_val="${1}"
	url="https://api.openbd.jp/v1/get?isbn=${isbn_val}&pretty"

	fetch_data "${url}" |
	grep -F -e "isbn" -e "title" -e "publisher" -e "pubdate" -e "author" |
	awk -F "\"" '
	NR < 5 {
		print $4
	}
	END {
		gsub("," , "", $4)
		gsub(/[0-9][0-9][0-9][0-9]-/, "", $4)
		gsub(/[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]/, "", $4)
		gsub(/[0-9][0-9][0-9][0-9]"/, "", $4)
		print $4
	}
	' |
	paste -s -d ',' - |
	sed '/^$/d'

}

# 国立国会図書館から書籍情報を取得する関数
fetch_ndl() {

	isbn_val="${1}"
	url="https://iss.ndl.go.jp/api/sru?operation=searchRetrieve&version=1.2&recordSchema=dcndl&onlyBib=true&recordPacking=xml&query=isbn=${isbn_val}%20AND%20dpid=iss-ndl-opac"

	fetch_data "${url}" |

	parsrx.sh |

	grep -F -e "BibResource/dcterms:title" -e "BibResource/dc:creator" -e "BibResource/dcterms:publisher/foaf:Agent/foaf:name" -e "BibResource/dcterms:date" |

	cut -d" " -f2- |

	paste -s -d ',' - |

	awk -F, -v isbn="${isbn_val}" '

	BEGIN{

		OFS = ","

	}

	{

		# $1から$4のいずれも空でない場合のみ処理
		if ($1 != "" && $2 != "" && $3 != "" && $4 != "") {

			if($5 != ""){

				# 海外本の翻訳者への対応
				print isbn, $1, $4, $5, $2 " " $3

			}else{

				print isbn, $1, $3, $4, $2

			}

		}

	}
	'
}
# ====== 関数の設定ここまで ======


# ====== メイン処理 ======
# 使用するAPIに応じて書籍情報を取得
case "${api}" in
	openbd)
		result="$(fetch_openbd "${isbn}")"
		;;
	ndl)
		result="$(fetch_ndl "${isbn}")"
		;;
esac

# 結果が空かつフォールバックが有効な場合
if [ -z "${result}" ] && [ "${fallback_enabled}" -eq 1 ]; then
	case "${api}" in
		openbd)
			result="$(fetch_ndl "${isbn}")"
			;;
		ndl)
			result="$(fetch_openbd "${isbn}")"
			;;
	esac
fi

# 結果を出力またはエラー処理
if [ -z "${result}" ]; then
	echo "Error: No data found for ISBN: ${isbn}" >&2
	exit 1
else
	echo "${result}"
fi
# ====== メイン処理ここまで ======

