#!/bin/sh

# shellcheck disable=SC1090

set -eu

# 環境変数の設定
export LC_ALL=C
export LANG=C
export POSIXLY_CORRECT=1

# 設定ファイルのパス
config_file="../book_manager.conf"

# 独自コマンドにパスを通す
export PATH="../bin:${PATH}"

# 関数の設定
# 設定を保存する関数
save_config() {

    # POSTデータからパラメータを抽出
    csv_file=""
    script_dir=""

    if [ "${REQUEST_METHOD:-GET}" = "POST" ] && [ -n "${CONTENT_LENGTH:-}" ]; then
        # POSTデータを読み込み
        post_data="$(cat | tbug)"

        # POSTデータをurldecode
		decoded_post=$(echo "$post_data" | urldecode)

        # パラメータを抽出
        csv_file=$(echo "${decoded_post}" | grep -o 'csv_file=[^&]*' | cut -d'=' -f2)
        script_dir=$(echo "${decoded_post}" | grep -o 'script_dir=[^&]*' | cut -d'=' -f2)
    fi

    # 設定ファイルを作成/更新
    cat > "${config_file}" <<- EOF
		# Book Manager Configuration
		# Generated by config.cgi

		# CSV file path
		csv_file="${csv_file}"

		# Environment variables
		LC_ALL=C
		LANG=C
		POSIXLY_CORRECT=1
	EOF

    # 成功メッセージを表示
    echo '<div class="result success">設定が保存されました。</div>'

}

# 設定を読み込む関数
load_config() {

	# 設定ファイルの有無を確認
    if [ -f "${config_file}" ]; then
        # 設定ファイルから変数を読み込み
        . "${config_file}"

        # 変数をエスケープして表示
        escaped_csv_file=$(printf '%s' "${csv_file}" | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g;s/"/\&quot;/g')
        escaped_script_dir=$(printf '%s' "${script_dir}" | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g;s/"/\&quot;/g')

        cat <<- EOF
			<div class="result success">現在の設定:</div>
			<pre>
			csv_file=${escaped_csv_file}
			script_dir=${escaped_script_dir}
			</pre>
		EOF

    else

        echo '<div class="result error">設定ファイルが見つかりません。</div>'

    fi

}

# 結果を出力
result() {

	if [ "${REQUEST_METHOD:-GET}" = "POST" ]; then
		save_config
	else
		load_config
	fi

}

# HTML
echo "Content-Type: text/html; charset=UTF-8"
echo ""

cat << EOF
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>設定結果 - Book Manager</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <h1>設定結果</h1>
    <p><a href="../html/config.html">設定ページ</a> | <a href="../html/index.html">メニュー</a></p>
	$(result)

</body>
</html>
EOF

